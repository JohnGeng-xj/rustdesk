name: Build Android APK

# 手动触发或推送到 master 时自动构建
on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'flutter/**'
      - 'src/**'
      - '.github/workflows/build-android-apk.yml'

env:
  RUST_VERSION: "1.75"
  CARGO_NDK_VERSION: "3.1.2"
  FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  build-android:
    name: Build Android APK (${{ matrix.arch }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            target: aarch64-linux-android
            android_abi: arm64-v8a
            platform: android-arm64
          - arch: armv7
            target: armv7-linux-androideabi
            android_abi: armeabi-v7a
            platform: android-arm
          - arch: x86_64
            target: x86_64-linux-android
            android_abi: x86_64
            platform: android-x64

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: false

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
               clang cmake curl git \
               g++ g++-multilib \
               libgtk-3-dev \
               libxcb-randr0-dev \
               libxcb-shape0-dev \
               libxcb-xfixes0-dev \
               libxfixes-dev \
               llvm-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config wget

      - name: Install NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
          link-to-sdk: true

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: "${{ github.workspace }}/vcpkg"
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}

      - name: Build Android dependencies
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
          VCPKG_ROOT: "${{ github.workspace }}/vcpkg"
        run: |
          ./flutter/build_android_deps.sh "${{ matrix.android_abi }}"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.target }}
          components: "rustfmt"

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: rustdesk-android-cache
          key: ${{ matrix.target }}

      - name: Build rustdesk library
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }} --locked
          rustup target add ${{ matrix.target }}

          # Build using project scripts
          case ${{ matrix.target }} in
            aarch64-linux-android)
              ./flutter/ndk_arm64.sh
              mkdir -p ./flutter/android/app/src/main/jniLibs/arm64-v8a
              cp ./target/${{ matrix.target }}/release/liblibrustdesk.so ./flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
              ;;
            armv7-linux-androideabi)
              ./flutter/ndk_arm.sh
              mkdir -p ./flutter/android/app/src/main/jniLibs/armeabi-v7a
              cp ./target/${{ matrix.target }}/release/liblibrustdesk.so ./flutter/android/app/src/main/jniLibs/armeabi-v7a/librustdesk.so
              ;;
            x86_64-linux-android)
              ./flutter/ndk_x64.sh
              mkdir -p ./flutter/android/app/src/main/jniLibs/x86_64
              cp ./target/${{ matrix.target }}/release/liblibrustdesk.so ./flutter/android/app/src/main/jniLibs/x86_64/librustdesk.so
              ;;
          esac

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build APK
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          export PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:$PATH

          # Configure Gradle
          sed -i "s/org.gradle.jvmargs=-Xmx1024M/org.gradle.jvmargs=-Xmx2g/g" ./flutter/android/gradle.properties
          sed -i "s/signingConfigs.release/signingConfigs.debug/g" ./flutter/android/app/build.gradle

          # Copy libc++_shared.so
          case ${{ matrix.target }} in
            aarch64-linux-android)
              mkdir -p ./flutter/android/app/src/main/jniLibs/arm64-v8a
              cp ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so ./flutter/android/app/src/main/jniLibs/arm64-v8a/
              ;;
            armv7-linux-androideabi)
              mkdir -p ./flutter/android/app/src/main/jniLibs/armeabi-v7a
              cp ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/libc++_shared.so ./flutter/android/app/src/main/jniLibs/armeabi-v7a/
              ;;
            x86_64-linux-android)
              mkdir -p ./flutter/android/app/src/main/jniLibs/x86_64
              cp ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/x86_64-linux-android/libc++_shared.so ./flutter/android/app/src/main/jniLibs/x86_64/
              ;;
          esac

          # Build Flutter APK
          pushd flutter
          flutter pub get
          flutter build apk --release --target-platform ${{ matrix.platform }} --split-per-abi
          popd

      - name: Prepare artifact
        run: |
          mkdir -p output
          case ${{ matrix.target }} in
            aarch64-linux-android)
              cp ./flutter/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk output/rustdesk-android-arm64-v8a-release.apk
              ;;
            armv7-linux-androideabi)
              cp ./flutter/build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk output/rustdesk-android-armeabi-v7a-release.apk
              ;;
            x86_64-linux-android)
              cp ./flutter/build/app/outputs/flutter-apk/app-x86_64-release.apk output/rustdesk-android-x86_64-release.apk
              ;;
          esac

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-${{ matrix.arch }}
          path: output/*.apk
          retention-days: 7

  # 构建 Universal APK (包含所有架构)
  build-android-universal:
    name: Build Android Universal APK
    runs-on: ubuntu-24.04
    needs: build-android

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: false

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
               clang cmake curl git \
               g++ g++-multilib \
               libgtk-3-dev \
               libxcb-randr0-dev \
               libxcb-shape0-dev \
               libxcb-xfixes0-dev \
               libxfixes-dev \
               llvm-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config wget

      - name: Install NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
          link-to-sdk: true

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: "${{ github.workspace }}/vcpkg"
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}

      - name: Build Android dependencies (all architectures)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK: ${{ steps.setup-ndk.outputs.ndk-path }}
          VCPKG_ROOT: "${{ github.workspace }}/vcpkg"
        run: |
          ./flutter/build_android_deps.sh "arm64-v8a"
          ./flutter/build_android_deps.sh "armeabi-v7a"
          ./flutter/build_android_deps.sh "x86_64"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android
          components: "rustfmt"

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: rustdesk-android-universal-cache

      - name: Build rustdesk libraries (all architectures)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }} --locked

          # Build all architectures
          ./flutter/ndk_arm64.sh
          ./flutter/ndk_arm.sh
          ./flutter/ndk_x64.sh

          # Copy libraries
          mkdir -p ./flutter/android/app/src/main/jniLibs/arm64-v8a
          mkdir -p ./flutter/android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p ./flutter/android/app/src/main/jniLibs/x86_64
          cp ./target/aarch64-linux-android/release/liblibrustdesk.so ./flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
          cp ./target/armv7-linux-androideabi/release/liblibrustdesk.so ./flutter/android/app/src/main/jniLibs/armeabi-v7a/librustdesk.so
          cp ./target/x86_64-linux-android/release/liblibrustdesk.so ./flutter/android/app/src/main/jniLibs/x86_64/librustdesk.so

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Build Universal APK
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          export PATH=/usr/lib/jvm/java-17-openjdk-amd64/bin:$PATH

          # Configure Gradle
          sed -i "s/org.gradle.jvmargs=-Xmx1024M/org.gradle.jvmargs=-Xmx2g/g" ./flutter/android/gradle.properties
          sed -i "s/signingConfigs.release/signingConfigs.debug/g" ./flutter/android/app/build.gradle

          # Copy libc++_shared.so for all architectures
          mkdir -p ./flutter/android/app/src/main/jniLibs/arm64-v8a
          mkdir -p ./flutter/android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p ./flutter/android/app/src/main/jniLibs/x86_64
          cp ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so ./flutter/android/app/src/main/jniLibs/arm64-v8a/
          cp ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/arm-linux-androideabi/libc++_shared.so ./flutter/android/app/src/main/jniLibs/armeabi-v7a/
          cp ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/x86_64-linux-android/libc++_shared.so ./flutter/android/app/src/main/jniLibs/x86_64/

          # Build Flutter APK (all architectures)
          pushd flutter
          flutter pub get
          flutter build apk --release --target-platform android-arm64,android-arm,android-x64
          popd

          # Copy output
          mkdir -p output
          cp ./flutter/build/app/outputs/flutter-apk/app-release.apk output/rustdesk-android-universal-release.apk

      - name: Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-universal
          path: output/*.apk
          retention-days: 7
