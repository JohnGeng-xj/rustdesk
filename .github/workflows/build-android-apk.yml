name: Build Android APK

# 手动触发或推送到 master 时自动构建
on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'flutter/**'
      - 'src/**'
      - '.github/workflows/build-android-apk.yml'

env:
  RUST_VERSION: "1.75"
  FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64-linux-android  # arm64
          - armv7-linux-androideabi # arm32
          - x86_64-linux-android   # x86_64

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: false

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
               clang cmake curl git \
               g++ g++-multilib \
               libgtk-3-dev \
               libxcb-randr0-dev \
               libxcb-shape0-dev \
               libxcb-xfixes0-dev \
               libxfixes-dev \
               llvm-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config wget

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${{ env.RUST_VERSION }}
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
          rustup target add ${{ matrix.arch }}

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version 3.1.2

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager "ndk;27.2.12479018"
          echo "ANDROID_NDK=/usr/local/lib/android/sdk/ndk/27.2.12479018" >> $GITHUB_ENV

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: "${{ github.workspace }}/vcpkg"
          vcpkgGitCommitId: "120deac3062162151622ca4860575a33844ba10b"

      - name: Build Rust FFI
        run: |
          cargo ndk --target ${{ matrix.arch }} \
                    --android-platform 24 \
                    build --release

      - name: Get Flutter dependencies
        working-directory: flutter
        run: flutter pub get

      - name: Build APK
        working-directory: flutter
        run: |
          case "${{ matrix.arch }}" in
            aarch64-linux-android)
              flutter build apk --release --target-platform android-arm64
              ;;
            armv7-linux-androideabi)
              flutter build apk --release --target-platform android-arm
              ;;
            x86_64-linux-android)
              flutter build apk --release --target-platform android-x64
              ;;
          esac

      - name: Rename APK
        working-directory: flutter
        run: |
          mkdir -p ../output
          case "${{ matrix.arch }}" in
            aarch64-linux-android)
              cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
                 ../output/rustdesk-android-arm64-v8a-release.apk
              ;;
            armv7-linux-androideabi)
              cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk \
                 ../output/rustdesk-android-armeabi-v7a-release.apk
              ;;
            x86_64-linux-android)
              cp build/app/outputs/flutter-apk/app-x86_64-release.apk \
                 ../output/rustdesk-android-x86_64-release.apk
              ;;
          esac

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-${{ matrix.arch }}
          path: output/*.apk
          retention-days: 7

  # 构建 Universal APK (包含所有架构)
  build-android-universal:
    name: Build Android Universal APK
    runs-on: ubuntu-24.04
    needs: build-android

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: true
          swap-storage: false

      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
               clang cmake curl git \
               g++ g++-multilib \
               libgtk-3-dev \
               libxcb-randr0-dev \
               libxcb-shape0-dev \
               libxcb-xfixes0-dev \
               libxfixes-dev \
               llvm-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config wget

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${{ env.RUST_VERSION }}
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source "$HOME/.cargo/env"
          rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version 3.1.2

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager "ndk;27.2.12479018"
          echo "ANDROID_NDK=/usr/local/lib/android/sdk/ndk/27.2.12479018" >> $GITHUB_ENV

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: "${{ github.workspace }}/vcpkg"
          vcpkgGitCommitId: "120deac3062162151622ca4860575a33844ba10b"

      - name: Build Rust FFI (all architectures)
        run: |
          cargo ndk --target aarch64-linux-android \
                    --target armv7-linux-androideabi \
                    --target x86_64-linux-android \
                    --android-platform 24 \
                    build --release

      - name: Get Flutter dependencies
        working-directory: flutter
        run: flutter pub get

      - name: Build Universal APK
        working-directory: flutter
        run: |
          flutter build apk --release \
            --target-platform android-arm64,android-arm,android-x64

      - name: Copy Universal APK
        working-directory: flutter
        run: |
          mkdir -p ../output
          cp build/app/outputs/flutter-apk/app-release.apk \
             ../output/rustdesk-android-universal-release.apk

      - name: Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-universal
          path: output/*.apk
          retention-days: 7
